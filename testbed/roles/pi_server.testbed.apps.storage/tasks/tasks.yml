- name: partition external storage
  become: true
  ansible.builtin.command:
    creates: "{{ pi_server_storage_drive }}{{ pi_server_storage_data_partition }}"
    cmd: "/sbin/sfdisk '{{ pi_server_storage_drive }}'"
    stdin: |
      ,50MiB
      ,

- name: check data partition is formatted
  become: true
  ansible.builtin.shell:
    cmd: "file -s '{{ pi_server_storage_drive }}{{ pi_server_storage_data_partition }}' | grep ext4"
  register: data_partition_formatted
  failed_when: false
  changed_when: false

- name: format data partition
  become: true
  ansible.builtin.command:
    cmd: "mkfs.ext4 '{{ pi_server_storage_drive }}{{ pi_server_storage_data_partition }}'"
  when: data_partition_formatted.rc != 0

- name: check backup partition is formatted
  become: true
  ansible.builtin.shell:
    cmd: "file -s '{{ pi_server_storage_drive }}{{ pi_server_storage_backup_partition }}' | grep ext4"
  register: backup_partition_formatted
  failed_when: false
  changed_when: false

- name: format backup partition
  become: true
  ansible.builtin.command:
    cmd: "mkfs.ext4 '{{ pi_server_storage_drive }}{{ pi_server_storage_backup_partition }}'"
  when: backup_partition_formatted.rc != 0
