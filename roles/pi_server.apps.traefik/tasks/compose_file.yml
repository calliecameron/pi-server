- name: Get ports
  become: true
  ansible.builtin.command:
    cmd: "cat '{{ pi_server_apps_traefik_ports_file }}'"
  register: raw_ports
  changed_when: false

- name: "Check if https is enabled"
  become: true
  ansible.builtin.command:
    cmd: "ls {{ pi_server_apps_traefik_https_enabled_file }}"
  register: exists
  failed_when: false
  changed_when: false

- name: Traefik user can read https key
  ansible.builtin.include_role:
    name: pi_server.apps.certs.https_key_reader
  vars:
    user: "{{ pi_server_apps_traefik_user }}"
  when: exists.rc == 0

- name: Compose file
  become: true
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ pi_server_apps_traefik_docker_compose }}"
    owner: root
    group: root
    mode: a=r
  vars:
    ports: "{{ raw_ports.stdout_lines }}"
    https_enabled: "{{ exists.rc == 0 }}"
  notify: Reload traefik
