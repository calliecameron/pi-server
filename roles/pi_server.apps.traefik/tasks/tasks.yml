- name: dependency
  ansible.builtin.include_role:
    name: pi_server.apps.docker

- name: dependency
  ansible.builtin.include_role:
    name: pi_server.apps.control_panel.base

- name: dependency
  ansible.builtin.include_role:
    name: pi_server.apps.traefik.base

- include_tasks: config_file.yml

- include_tasks: compose_file.yml

- include_tasks: compose.yml
  vars:
    restart: no

- name: monitor containers
  ansible.builtin.include_role:
    name: pi_server.apps.monitoring.monitor_docker_compose
  vars:
    compose_file: "{{ pi_server_apps_traefik_docker_compose }}"

- name: scrape job
  ansible.builtin.include_role:
    name: pi_server.apps.monitoring.scrape_job
  vars:
    job: traefik
    host: traefik
    port: "{{ pi_server_apps_traefik_metrics_port }}"
    metrics_path: /metrics

- name: control panel fragment
  ansible.builtin.include_role:
    name: pi_server.apps.control_panel.fragment
  vars:
    src: fragment.html.j2
    name: traefik
