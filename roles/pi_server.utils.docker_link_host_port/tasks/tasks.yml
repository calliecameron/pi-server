- include_role:
    name: pi_server.apps.firewall

- include_role:
    name: pi_server.apps.docker

- name: get container ID
  become: yes
  ansible.builtin.command:
    cmd: "docker-compose -f {{ compose_file }} ps -q --filter {{ service }}"
  register: container_id
  changed_when: false

- name: get IP address
  become: yes
  ansible.builtin.command:
    cmd: "docker inspect  --format '{{ '{{' }} range .NetworkSettings.Networks {{ '}}{{' }} .IPAddress {{ '}}{{' }} end {{ '}}' }}' {{ container_id.stdout }}"
  register: container_addr
  changed_when: false

- name: get docker interface
  become: yes
  ansible.builtin.command:
    cmd: "docker network inspect -f '{{ '{{' }}index .Options \"com.docker.network.bridge.name\" {{ '}}' }}' bridge"
  register: docker_iface
  changed_when: false

- name: "allow {{ service }} to access host port {{ host_port }}"
  become: yes
  community.general.ufw:
    rule: allow
    proto: tcp
    from_ip: "{{ container_addr.stdout }}"
    to_ip: "{{ ansible_facts[docker_iface.stdout][\"ipv4\"][\"address\"] }}"
    to_port: "{{ host_port }}"
  notify: reload firewall
